---
cc: true
comments: true
date: '2015-04-19 23:19:11'
jscomments:
  id: /2015/04/19/a-speech-from-mr-zhao/
  title: 赵海平分享小记——关于 Facebook，关于 Alibaba
  url: http://blog.jamespan.me/2015/04/19/a-speech-from-mr-zhao/
routes:
  aliases:
  - posts/a-speech-from-mr-zhao
  default: /2015/04/19/a-speech-from-mr-zhao
taxonomy:
  category:
  - blog
  - Work
  tag:
  - Speech
title: 赵海平分享小记——关于 Facebook，关于 Alibaba
---

2015 年 4 月 7 日晚上，离开 Facebook 加入 Alibaba 的赵海平先生，在阿里巴巴的总部，进行了一次题为《我眼中的 Facebook 技术演进》分享，关于 Facebook 的技术演进。

分享原定 6:30 开始，内网上报名参加的人数接近 1500，害怕报告厅装不下如此多人，我和同事 6:15 便到了会场，挑选了前排位置坐下。

===



一开始，大概在 2004 年，Facebook 就是一个单纯的 LAMP 架构的小网站，用户信息保存在一张名为 info 的表里面。

后来随着用户数量的增加，单库单表没法满足存储的需求，大约在 2006 年，Facebook 开始按照学校或者用户 id 把用户的数据路由到不同的数据库去存储，那时候大家都用一个 id2db 函数去获取从 用户到数据库的映射。

久而久之这个函数就变得复杂无比，难以维护。主程序是用 PHP 写的，其他语言又没法直接调用 PHP 的函数，赵海平先生当时使用的是 C++，只好自己实现了一遍，当 PHP 的函数有变化时，其他语言版本的 id2db 只能人肉跟进。

再后来数据库抗不住了，连接数超出了 MySQL 的承受范围，于是 Memcached 出场了，直接把 MySQL 从应用服务器手上救了下来。Memcached 的查询非常快，大概 0.5ms 就能返回查询结果，从此网络进入毫秒时代。

接下来的几年，同步 IO 劣势凸显，异步 IO 大展宏图，以 libevent 为首的异步处理，将网络程序带入了异步时代。从那时起，Facebook 中越来越多的新代码使用 libevent 做异步 IO，老代码也渐渐被重构。和线程模型相比，libevent 所代表的事件驱动模型，更加适合互联网环境下高 IO 的场景。

大约在 2007 年，Facebook 搞了个开放平台，弄了一套 FBML、FBCSS 和 FBJS。一开始的时候，这三样东西是用 PHP 实现的，结果运行效率成了大问题，几乎不可用。赵海平先生直接用 C++ 重写，速度提高几十倍。

那时候赵海平先生还顺便弄了 XHProfLive，一个实时收集、剖析 PHP 程序的运行状况、速度、消耗等等。他认为功能、测试和监控是程序开发的三套车，大部分的开发人员写功能很厉害，单元测试写的也还行，到了监控上就基本不怎么样了。

为了让网页响应更快，Facebook 把一些和渲染网页无关的工作异步化了，在 PHP 语言中增加了一些黑科技，比如 “Post-Send Processing”，在页面返回之后处理一些发消息、cleanUp 等任务，还有 “Async Tier” 用于做 PHP 的函数延迟、重试、多机化等等。

到了 2008 年，Facebook 的机器开始出现 CPU 负载较高的问题，这种已经是 PHP 语言层面的问题了，那时候赵海平先生开始做 HipHop 的相关工作，就是把 PHP 翻译成 C++，然后编译执行。

那时候它不是吃定了这个项目，有一个同事在和他竞争，那个同事借助商业软件，把 PHP 翻译成 Java。最终竞争的结果是赵海平胜出了。

2011 年，Hadoop 进入 Facebook 的技术栈，大数据处理开始火热，Facebook 把它的日志全都记录在了 Hadoop 上，因为 Hadoop 天生擅长处理大量的顺序写。

2014 年，Facebook 搞出了著名的 HHVM，一个 PHP 的 JIT 虚拟机，用于取代之前的 HipHop。然而 HHVM 并没有带来比 HipHop 高出许多的性能提升，原因是 GCC 本身的代码优化已经足够强大了，能够把 HipHop 生成的不优化的 C++ 代码优化成高效的机器码，JIT 也不是万能药，不是用了它代码效率就能飞跃。

当然 HHVM 的好处也是有很多的，最大的好处是部署。之前使用 HipHop 编译出来的可执行文件有两个 G，部署都成了大问题。用了 HHVM 之后可以直接部署源文件。

最后，赵海平先生提出一个设想：互联网应用的执行过程，无非是从这个地方获取一些数据，从那个地方获取一些数据，对数据稍作加工生成新的数据。这个获取数据的过程以及数据之间的依赖关系可以用一颗树来表达，如果我们能优化这棵树，让能并行的任务并行，尽量少的去获取数据，我们的应用跑的就更快。

分享结束之后是问答环节，赵海平先生在这里展示了它的机智和风趣。

开始的时候，赵海平先生分享了他为什么加入 Alibaba。到了提问环节，有同事问他什么时候打算离开。赵海平先生机智的说了 Alibaba 目前在技术上的各种不足，然后说，你问我什么时候离开，其实就是再问我解决这些问题要用多长时间。

有同事问他对高级技术人员很少写代码的看法，他说他早上才提交了许多代码，整个会场顿时掌声雷动。

在他看来，高级技术人员需要为项目负责，最好是能够在项目一开始亲自上阵，为整个项目打下一个良好的框架，其他人在框架上添砖加瓦，这样子整个项目才不会失控。

比如 Facebook 在的 HTML5 上遭遇的滑铁卢，就是因为高级技术人员一开始没有亲自上阵，然后 PR 又对外公布了消息，于是大家只好硬着头皮做。如果一开始就有高级人员参与，亲自做个 Demo，谁都能发现 HTML 5 在当时的设备上，没法提供和 Native 接近的体验（似乎到现在都还不行），也就不会选择一种不合适的技术。

还有同事问了他那个传说中的 “The Greatest Computer Scientist” 头衔，赵海平先生当即表示他被国内的科技媒体坑惨了。那个根本不是什么头衔，而是他工牌上的字，每个 Facebook 员工都有类似的对自己的期许。

还有许多同事问了各种各样的问题，好多我都不记得了。

赵海平先生是那种天赋比你高的人比你还努力的典型例子，像我这种天赋平庸的家伙，更要努力才行呀！