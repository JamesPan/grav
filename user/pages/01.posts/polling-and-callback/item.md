---
cc: true
comments: true
date: '2015-06-18 00:00:05'
jscomments:
  id: /2015/06/18/polling-and-callback/
  title: 轮询与回调
  url: http://blog.jamespan.me/2015/06/18/polling-and-callback/
math: true
routes:
  aliases:
  - posts/polling-and-callback
  default: /2015/06/18/polling-and-callback
taxonomy:
  category:
  - Essay
  - blog
  - Life
  tag:
  - Thinking
title: 轮询与回调
---

刚开始使用电子邮件的时候，用的 QQ 邮箱。那时候也没有使用邮件客户端，就是挂着个 QQ，收到邮件之后会在桌面右下角弹出个提醒，然后点开就进入了邮箱的 Web 界面。渐渐的我有了多个 QQ 号，自然就有了多个 QQ 邮箱。

===



后来上了高中，开始使用 Gmail，然后用 Gmail 以 POP3 协议去收取各路邮箱。再后来上了大学有了 edu 邮箱，毕业之后偶尔还用这个邮箱伪装学生身份，也是被 Gmail 收取。在 Google 被墙之前，Gmail 的使用体验简直无可挑剔，无论是电脑上用 Thundbird 作为客户端，还是 Android 上原生的 Gmail App，都能在邮件到达之后的几秒钟给我一个提醒。

后来，我们为了能够访问全球互联网，八仙过海各显神通。但是，长城内外终究是产生了隔阂，收个邮件都得拿出梯子，着实不便。但是，我也就这样将就了好几年。

最近我开始用 iCloud 的邮件服务了。

自从 Google 关闭了 exchange 之后，在 iOS 设备上收取 Gmail 邮件，一般只能用“获取”而不能用“推送”。获取的意思就是每个 N 分钟去服务器获取一次邮件，$min(N) = 15$，而获取的前提是能够访问国际互联网。这样子一来我从手机上收取邮件就变得比较复杂而且别扭了，倒是在电脑上收取邮件比较顺畅。

但是我还是想用手机收取私人邮件，于是我试着把 Gmail 的邮件转发到 iCloud，然后把其他被 Gmail 通过 POP3 收取的邮箱的邮件也转发到 iCloud。然后我就能在手机上愉快地享受延迟可以忽略的邮件推送了。

这次我在手机收取邮件策略上的变化，让我想起编程中两种常见的策略：轮询和回调。

早先的“获取”策略其实就是轮询，客户端不停（间歇）地发起请求，询问服务端是否有新数据产生，如果有新数据就把新数据抓取下来。由于客户端消费邮件的速度远大于新邮件到达服务端的速度，绝大部分的请求都是做无用功。

为了减少朴素轮询中的无用请求，机智的开发者发明了“长轮询”。客户端发起请求，如果有新数据则立即返回，否则服务端持有请求并等待新数据一段时间再返回。这种策略极大的减少了客户端发起的无用请求，但是加大了服务端的开销。

回调策略与轮询策略截然相反。回调就像好莱坞原则，Don't call us, we'll call you，不是客户端主动向服务端请求数据，而是服务端向客户端推送数据。

长连接是服务端数据推送的一种实现方式，通常借助 iframe 来实现[^1]。

[^1]: [Comet：基于 HTTP 长连接的“服务器推”技术][1]

在我的感觉中，轮询和回调的差别，就像同步和异步的差别那么大。虽然同步在实现上更加简单，但是异步的效率却更高。

其实我个人更加倾向于异步的方式，不仅在技术上，也在生活上。

在沟通上，我更倾向于异步的交流，电子邮件是上选，短信、IM 次之，电话最次。采用异步的方式，双方都可以选择最合适的时间、环境进行回复，没有中断，没有阻塞，只有提醒。

支付体验上，Uber 远胜于其他 App，秘诀也在于异步。乘客下车之后，Uber 自动从支付宝或者信用卡中扣费，不需要输入金额，不需要输入密码，不需要指纹支付。这就是传说中的“因为信任，所以简单”?


[1]: http://www.ibm.com/developerworks/cn/web/wa-lo-comet/